<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yuzi.denture.data.mapper.FactoryUserMapper" >

    <insert id="save" useGeneratedKeys="true" keyProperty="id" parameterType="com.yuzi.denture.domain.FactoryUser">
        INSERT INTO factory_user
        (
        `name`,
        `contact`,
        `password`,
        `group_type`,
        `join_date`,
        `factory_id`
        )
        VALUES
        (
        #{name},
        #{contact},
        #{password},
        #{groupType},
        #{joinDate},
        #{factoryId}
        );
    </insert>

    <update id="update" parameterType="com.yuzi.denture.domain.FactoryUser">
        UPDATE `liyou`.`factory_user`
        SET
        `id` = id
        <if test="name!=null">
            ,`name` = #{name}
        </if>
        <if test="contact!=null">
            ,`contact` = #{contact}
        </if>
        <if test="groupType!=null">
            ,`group_type` = #{groupType}
        </if>
        <if test="joinDate!=null">
            ,`join_date` = #{joinDate}
        </if>
        <if test="password!=null">
            ,`password` = #{password}
        </if>
        WHERE `id` = #{id};
    </update>

    <insert id="addRole" parameterType="com.yuzi.denture.domain.FactoryRole">
        INSERT INTO factory_role
        (
        `factory_uid`,
        `role`
        )
        VALUES
        (
        #{uid},
        #{role}
        );
    </insert>

    <insert id="addCustomer" parameterType="com.yuzi.denture.domain.FactoryCustomer">
        INSERT INTO `liyou`.`factory_customer`
        (
        `factory_id`,
        `clinic_id`,
        `salesman_id`,
        `is_valid`,
        `created_date`
        )
        VALUES
        (
        #{factoryId},
        #{clinic.id},
        #{salesmanId},
        #{isValid},
        #{createdDate}
        );
    </insert>
    <update id="updateCustomer" parameterType="com.yuzi.denture.domain.FactoryCustomer">
        UPDATE `liyou`.`factory_customer`
        SET
        `id` = id
        <if test="factoryId!=null">
            ,`factory_id` = #{factoryId}
        </if>
        <if test="clinic!=null">
            ,`clinic_id` = #{clinic.id}
        </if>
        <if test="salesmanId!=null">
            ,`salesman_id` = #{salesmanId}
        </if>
        <if test="isValid!=null">
            ,`is_valid` = #{isValid}
        </if>
        <if test="createdDate!=null">
            ,`created_date` = #{createdDate}
        </if>
        WHERE `id` = #{id};
    </update>

    <resultMap id="baseRM" type="com.yuzi.denture.domain.FactoryUser">
        <result column="id" property="id" />
        <result column="factory_id" property="factoryId" />
        <result column="name" property="name" />
        <result column="contact" property="contact" />
        <result column="password" property="password" />
        <result column="group_type" property="groupType" />
        <result column="join_date" property="joinDate" />
        <collection property="roles" resultMap="baseRoleRM" />
    </resultMap>
    <resultMap id="baseRoleRM" type="com.yuzi.denture.domain.FactoryRole">
        <result column="id" property="uid" />
        <result column="role" property="role" />
    </resultMap>
    <resultMap id="baseCustomerRM" type="com.yuzi.denture.domain.FactoryCustomer">
        <result column="id" property="id" />
        <result column="factory_id" property="factoryId" />
        <result column="salesman_id" property="salesmanId" />
        <result column="created_date" property="createdDate" />
        <result column="is_valid" property="isValid" />
        <association property="clinic" jdbcType="com.yuzi.denture.domain.Clinic">
            <result column="clinic_id" property="id" />
            <result column="clinic_name" property="name" />
            <result column="clinic_address" property="address" />
            <result column="clinic_contact" property="contact" />
        </association>
    </resultMap>

    <sql id="baseCustomerSQL">
        fc.id id, fc.factory_id factory_id, salesman_id, fc.created_date created_date, is_valid,
        c.id clinic_id, c.name clinic_name, c.address clinic_address, c.contact clinic_contact
    </sql>
    <select id="findCustomerById" parameterType="Long" resultMap="baseCustomerRM">
        SELECT <include refid="baseCustomerSQL" /> FROM factory_customer fc
        inner join clinic c on (fc.id=#{id} and fc.clinic=c.id)
    </select>
    <select id="findCustomersByUid" parameterType="Long" resultMap="baseCustomerRM">
        SELECT <include refid="baseCustomerSQL" /> FROM factory_customer fc
        inner join clinic c on (fc.salesman_id=#{uid} and fc.clinic=c.id)
    </select>
    <select id="findUserByContact" resultMap="baseRM">
        select fu.*, fr.role from factory_user fu
        inner join factory_role fr
        on (contact=#{contact} and fu.id=fr.factory_uid)
    </select>
    <select id="findUserById" resultMap="baseRM">
        SELECT * FROM factory_user
        WHERE id=#{id}
    </select>
    <select id="findUsersByFactoryId" resultMap="baseRM">
        SELECT * FROM factory_user
        WHERE factory_id=#{factoryId}
    </select>

</mapper>