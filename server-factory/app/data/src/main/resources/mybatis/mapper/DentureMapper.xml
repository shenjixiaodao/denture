<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yuzi.denture.data.mapper.DentureMapper" >

    <insert id="save" parameterType="com.yuzi.denture.domain.Denture">
        INSERT INTO denture
        (
        `id`,
        `clinic_id`,
        `type`,
        `specification`,
        `factory_id`,
        `number`,
        `color_no`,
        `positions`,
        `created_date`,
        `comment`
        )
        VALUES
        (
        #{id},
        #{clinic.id},
        #{type},
        #{specification},
        #{factory.id},
        #{number},
        #{colorNo},
        #{positions},
        #{createdDate},
        #{comment}
        );
    </insert>
    <update id="update" parameterType="com.yuzi.denture.domain.Denture">
        UPDATE denture
        SET
        `id` = id
        <if test="clinic!=null">
            ,`clinic_id` = #{clinic.id}
        </if>
        <if test="type!=null">
            ,`type` = #{type}
        </if>
        <if test="specification!=null">
            ,`specification` = #{specification}
        </if>
        <if test="factory!=null">
            ,`factory_id` = #{factory.id}
        </if>
        <if test="number!=null">
            ,`number` = #{number}
        </if>
        <if test="colorNo!=null">
            ,`color_no` = #{colorNo}
        </if>
        <if test="positions!=null">
            `positions` = #{positions}
        </if>
        <if test="createdDate!=null">
            ,`created_date` = #{createdDate}
        </if>
        <if test="modelInspector!=null">
            ,`model_inspector_id` = #{modelInspector.id}
        </if>
        <if test="modelInspectionDate!=null">
            ,`model_inspection_date` = #{modelInspectionDate}
        </if>
        <if test="startDate!=null">
            ,`start_date` = #{startDate}
        </if>
        <if test="endDate!=null">
            ,`end_date` = #{endDate}
        </if>
        <if test="proReview!=null">
            ,`pro_review` = #{proReview}
        </if>
        <if test="proReviewDate!=null">
            ,`pro_review_date` = #{proReviewDate}
        </if>
        <if test="quaReview!=null">
            ,`qua_review` = #{quaReview}
        </if>
        <if test="quaReviewDate!=null">
            ,`qua_review_date` = #{quaReviewDate}
        </if>
        WHERE `id` = #{id};
    </update>
    <resultMap id="baseRM" type="com.yuzi.denture.domain.Denture">
        <result column="id" property="id" />
        <result column="type" property="type" />
        <result column="specification" property="specification" />
        <result column="factory_id" property="factory.id" />
        <result column="number" property="number" />
        <result column="positions" property="positions" />
        <result column="color_no" property="colorNo" />
        <result column="created_date" property="createdDate" />
        <result column="model_inspector_id" property="modelInspector.id" />
        <result column="model_inspection_date" property="modelInspectionDate" />
        <result column="start_date" property="startDate" />
        <result column="end_date" property="endDate" />
        <result column="pro_review" property="proReview" />
        <result column="pro_review_date" property="proReviewDate" />
        <result column="qua_review" property="quaReview" />
        <result column="qua_review_date" property="quaReviewDate" />
        <association property="clinic" javaType="com.yuzi.denture.domain.Clinic">
            <result column="clinic_id" property="id" />
            <result column="clinic_name" property="name" />
            <result column="clinic_address" property="address" />
            <result column="clinic_contact" property="contact" />
        </association>
        <collection property="procedureGroups" ofType="com.yuzi.denture.domain.ProcedureGroup">
            <result column="pg_id" property="id" />
            <result column="pg_type" property="type" />
            <result column="pg_dentureId" property="dentureId" />
            <result column="pg_start_date" property="startDate" />
            <result column="pg_end_date" property="endDate" />
            <result column="pg_operator_id" property="operator.id" />
            <result column="pg_inspector_id" property="inspector.id" />
            <result column="pg_inspection_content" property="inspectionContent" />
            <result column="pg_inspection_result" property="inspectionResult" />
        </collection>
    </resultMap>

    <sql id="baseSQL">
        d.id id, d.type type , d.specification specification, d.clinic_id clinic_id,
        d.factory_id factory_id, d.number number, d.positions positions, d.color_no color_no, d.created_date created_date,
        d.model_inspector_id model_inspector_id, d.model_inspection_date model_inspection_date,
        d.start_date start_date, d.end_date end_date, d.pro_review pro_review, d.pro_review_date pro_review_date,
        d.qua_review qua_review, d.qua_review_date qua_review_date
    </sql>

    <sql id="clinicSQL">
        c.name clinic_name, c.address clinic_address, c.contact clinic_contact
    </sql>
    <sql id="procedureGroupSQL">
        pg.id pg_id, pg.type pg_type, pg.denture_id pg_dentureId, pg.start_date pg_start_date, pg.end_date pg_end_date,
        pg.operator_id pg_operator_id, pg.inspector_id pg_inspector_id, pg.inspection_content pg_inspection_content,
        pg.inspection_result pg_inspection_result
    </sql>
    <select id="findByDentureId" parameterType="String" resultMap="baseRM">
        SELECT <include refid="baseSQL" />, <include refid="clinicSQL" />, <include refid="procedureGroupSQL" />
        FROM denture d inner join clinic c on (d.id=#{dentureId} and d.clinic_id=c.id)
        INNER JOIN procedure_group pg ON (pg.denture_id=#{dentureId} and d.id=pg.denture_id)
    </select>

    <select id="findDenturesByFactoryId" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" /> FROM denture d
        WHERE d.factory_id=#{factoryId}
    </select>

    <select id="findWaitingDentures" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" />
        FROM denture d inner join denture_order do on (
          d.factory_id=#{factoryId} and do.factory_id=#{factoryId} and d.id=do.denture_id
          and do.status in('Created','Paid')
        )
    </select>
    <select id="findByDeliveryInfo" parameterType="Map" resultMap="baseRM">
        SELECT <include refid="baseSQL" /> FROM denture d
        INNER JOIN delivery_info di ON (delivery_id=#{deliveryId} AND company=#{company} AND d.id=di.denture_id)
    </select>

    <select id="findDoingDentures" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" />
        FROM denture d inner join denture_order do on (
        d.factory_id=#{factoryId} and do.factory_id=#{factoryId} and d.id=do.denture_id
        and do.status in('Accepted','Making','Inspecting','PackAndClr','Released','Return','Remaking')
        )
    </select>
    <select id="findDoneDentures" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" />
        FROM denture d inner join denture_order do on (
        d.factory_id=#{factoryId} and do.factory_id=#{factoryId} and d.id=do.denture_id
        and do.status in('Rejected','Installed')
        )
    </select>
</mapper>