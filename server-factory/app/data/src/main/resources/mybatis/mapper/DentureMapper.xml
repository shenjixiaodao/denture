<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yuzi.denture.data.mapper.DentureMapper" >

    <insert id="save" parameterType="com.yuzi.denture.domain.Denture">
        INSERT INTO denture
        (
        `id`,
        `clinic_id`,
        `type`,
        `specification`,
        `factory_id`,
        `number`,
        `color_no`,
        `positions`,
        `created_date`,
        `comment`,
        `field_typ`,
        `bite_level`,
        `border_type`,
        `neck_type`,
        `inner_crown_type`,
        `padding_type`,
        `outer_crown_type`,
        `requirement`,
        `base_price`,
        `facotry_price`,
        `estimated_duration`
        )
        VALUES
        (
        #{id},
        #{clinic.id},
        #{type},
        #{specification},
        #{factory.id},
        #{number},
        #{colorNo},
        #{positions},
        #{createdDate},
        #{comment},
        #{fieldType},
        #{biteLevel},
        #{borderType},
        #{neckType},
        #{innerCrownType},
        #{paddingType},
        #{outerCrownType},
        #{requirement},
        #{basePrice},
        #{factoryPrice},
        #{estimatedDuration}
        );
    </insert>
    <update id="update" parameterType="com.yuzi.denture.domain.Denture">
        UPDATE denture
        SET
        `id` = id
        <if test="clinic!=null">
            ,`clinic_id` = #{clinic.id}
        </if>
        <if test="type!=null">
            ,`type` = #{type}
        </if>
        <if test="specification!=null">
            ,`specification` = #{specification}
        </if>
        <if test="factory!=null">
            ,`factory_id` = #{factory.id}
        </if>
        <if test="number!=null">
            ,`number` = #{number}
        </if>
        <if test="colorNo!=null">
            ,`color_no` = #{colorNo}
        </if>
        <if test="positions!=null">
            `positions` = #{positions}
        </if>
        <if test="createdDate!=null">
            ,`created_date` = #{createdDate}
        </if>
        <if test="modelInspector!=null">
            ,`model_inspector_id` = #{modelInspector.id}
        </if>
        <if test="modelInspectionDate!=null">
            ,`model_inspection_date` = #{modelInspectionDate}
        </if>
        <if test="startDate!=null">
            ,`start_date` = #{startDate}
        </if>
        <if test="endDate!=null">
            ,`end_date` = #{endDate}
        </if>
        <if test="proReview!=null">
            ,`pro_review` = #{proReview}
        </if>
        <if test="proReviewDate!=null">
            ,`pro_review_date` = #{proReviewDate}
        </if>
        <if test="quaReview!=null">
            ,`qua_review` = #{quaReview}
        </if>
        <if test="quaReviewDate!=null">
            ,`qua_review_date` = #{quaReviewDate}
        </if>
        <if test="requirement!=null">
            ,`requirement` = #{requirement}
        </if>
        <if test="basePrice!=null">
            ,`base_price` = #{basePrice}
        </if>
        <if test="factoryPrice!=null">
            ,`factory_price` = #{factoryPrice}
        </if>
        <if test="estimatedDuration!=null">
            ,`estimated_duration` = #{estimatedDuration}
        </if>
        WHERE `id` = #{id};
    </update>
    <resultMap id="baseRM" type="com.yuzi.denture.domain.Denture">
        <result column="id" property="id" />
        <result column="type" property="type" />
        <result column="specification" property="specification" />
        <result column="factory_id" property="factory.id" />
        <result column="number" property="number" />
        <result column="positions" property="positions" />
        <result column="color_no" property="colorNo" />
        <result column="created_date" property="createdDate" />
        <result column="model_inspector_id" property="modelInspector.id" />
        <result column="model_inspection_date" property="modelInspectionDate" />
        <result column="start_date" property="startDate" />
        <result column="end_date" property="endDate" />
        <result column="pro_review" property="proReview" />
        <result column="pro_review_date" property="proReviewDate" />
        <result column="qua_review" property="quaReview" />
        <result column="qua_review_date" property="quaReviewDate" />
        <result column="requirement" property="requirement" />
        <result column="base_price" property="basePrice" />
        <result column="factory_price" property="factoryPrice" />
        <result column="estimated_duration" property="estimatedDuration" />
        <association property="clinic" javaType="com.yuzi.denture.domain.Clinic">
            <result column="clinic_id" property="id" />
            <result column="clinic_name" property="name" />
            <result column="clinic_region" property="region" />
            <result column="clinic_address" property="address" />
            <result column="clinic_contact" property="contact" />
        </association>
        <collection property="procedureGroups" ofType="com.yuzi.denture.domain.ProcedureGroup">
            <result column="pg_id" property="id" />
            <result column="pg_type" property="type" />
            <result column="pg_dentureId" property="dentureId" />
            <result column="pg_start_date" property="startDate" />
            <result column="pg_end_date" property="endDate" />
            <result column="pg_operator_id" property="operator.id" />
            <result column="pg_inspector_id" property="inspector.id" />
            <result column="pg_inspection_content" property="inspectionContent" />
            <result column="pg_inspection_result" property="inspectionResult" />
        </collection>
        <collection property="appliedIngredients" ofType="com.yuzi.denture.domain.AppliedIngredient">
            <result column="ai_ingredient_id" property="ingredient.id" />
            <result column="aii_name" property="ingredient.name" />
            <result column="ai_denture_id" property="dentureId" />
            <result column="ai_no" property="no" />
            <result column="ai_applicant_id" property="applicant.id" />
            <result column="ai_applied_number" property="appliedNumber" />
            <result column="ai_applied_date" property="appliedDate" />
            <result column="ai_comment" property="comment" />
        </collection>
    </resultMap>

    <!--<sql id="baseSQL">
        d.id id, d.type type , d.specification specification, d.clinic_id clinic_id,
        d.factory_id factory_id, d.number number, d.positions positions, d.color_no color_no, d.created_date created_date,
        d.model_inspector_id model_inspector_id, d.model_inspection_date model_inspection_date,
        d.start_date start_date, d.end_date end_date, d.pro_review pro_review, d.pro_review_date pro_review_date,
        d.qua_review qua_review, d.qua_review_date qua_review_date
    </sql>-->
    <sql id="baseSQL">
        d.*
    </sql>

    <sql id="clinicSQL">
        c.name clinic_name, c.region clinic_region, c.address clinic_address, c.contact clinic_contact
    </sql>
    <sql id="procedureGroupSQL">
        pg.id pg_id, pg.type pg_type, pg.denture_id pg_dentureId, pg.start_date pg_start_date, pg.end_date pg_end_date,
        pg.operator_id pg_operator_id, pg.inspector_id pg_inspector_id, pg.inspection_content pg_inspection_content,
        pg.inspection_result pg_inspection_result
    </sql>
    <sql id="appliedIngredientSQL">
        ai.ingredient_id ai_ingredient_id, aii.name aii_name, ai.denture_id ai_denture_id, ai.no ai_no, ai.applied_number ai_applied_number,
        ai.applicant_id ai_applicant_id, ai.applied_date ai_applied_date, ai.comment ai_comment
    </sql>
    <sql id="criteriaWhere">
        where 1=1
        <if test="dentureId!=null">
            and d.id=#{dentureId}
        </if>
        <if test="createdDate">
            and DATE_FORMAT(d.createdDate,'%Y-%m-%d')=#{createdDate}
        </if>
        <if test="patientName!=null">
            and patient.name=#{patientName}
        </if>
        <if test="region!=null">
            and c.region like CONCAT('%',#{region},'%')
        </if>
        <if test="clinicName!=null">
            and c.name=#{clinicName}
        </if>
    </sql>

    <select id="findByDentureId" parameterType="String" resultMap="baseRM">
        SELECT <include refid="baseSQL" />, <include refid="clinicSQL" />,
        <include refid="procedureGroupSQL" />, <include refid="appliedIngredientSQL" />
        FROM denture d inner join clinic c on (d.id=#{dentureId} and d.clinic_id=c.id)
        INNER JOIN procedure_group pg ON (pg.denture_id=#{dentureId} and d.id=pg.denture_id)
        left join applied_ingredient ai on d.id=ai.denture_id
        left join ingredient aii on ai.ingredient_id=aii.id
    </select>

    <select id="findDenturesByFactoryId" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" /> FROM denture d
        WHERE d.factory_id=#{factoryId}
    </select>

    <select id="findWaitingDentures" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" />
        FROM denture d inner join denture_order do on (
          d.factory_id=#{factoryId} and do.factory_id=#{factoryId} and d.id=do.denture_id
          and do.status in('Created','Paid')
        )
        inner join clinic c on (d.clinic_id=c.id)
        <include refid="criteriaWhere" />
    </select>
    <select id="findByDeliveryInfo" parameterType="Map" resultMap="baseRM">
        SELECT <include refid="baseSQL" /> FROM denture d
        INNER JOIN delivery_info di ON (delivery_id=#{deliveryId} AND company=#{company} AND d.id=di.denture_id)
    </select>

    <select id="findDoingDentures" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" />
        FROM denture d
        inner join denture_order do on (
            d.factory_id=#{factoryId} and do.factory_id=#{factoryId} and d.id=do.denture_id
            and do.status in('Accepted','Making','Inspecting','PackAndClr','Released','Return','Remaking')
          )
        inner join clinic c on (d.clinic_id=c.id)
        <include refid="criteriaWhere" />
    </select>
    <select id="findDoneDentures" parameterType="Long" resultMap="baseRM">
        SELECT <include refid="baseSQL" />
        FROM denture d inner join denture_order do on (
        d.factory_id=#{factoryId} and do.factory_id=#{factoryId} and d.id=do.denture_id
        and do.status in('Rejected','Installed')
        )
        inner join clinic c on (d.clinic_id=c.id)
        <include refid="criteriaWhere" />
    </select>
</mapper>